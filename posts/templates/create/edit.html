{% extends "base.html" %}
{% block content %}
{% load custom_filters %}
<main role="main" class="container py-4">
  <form id="post-form" method="post">
    {% csrf_token %}
    <input type="hidden" name="change_reason" id="change_reason">

    {% if post.status == 'draft' %}
    <h1>Editar artículo</h1>

    <!-- Tabs de Bootstrap -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="informacion-tab" data-bs-toggle="tab" href="#informacion" role="tab"
          aria-controls="informacion" aria-selected="true">Información</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="cuerpo-tab" data-bs-toggle="tab" href="#cuerpo" role="tab" aria-controls="cuerpo"
          aria-selected="false">Cuerpo</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="historial-tab" data-bs-toggle="tab" href="#historial" role="tab"
          aria-controls="historial" aria-selected="false">Historial de versiones</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="observaciones-tab" data-bs-toggle="tab" href="#observaciones" role="tab"
          aria-controls="observaciones" aria-selected="false">Observaciones</a>
      </li>
    </ul>

    <!-- Contenido de las Tabs -->
    <div class="tab-content" id="myTabContent">
      <!-- Información Tab -->
      <div class="tab-pane fade show active" id="informacion" role="tabpanel" aria-labelledby="informacion-tab">
        <div class="py-3">
          <div class="form-group">
            <label for="id_title">Título</label>
            {{ information_form.title }}
          </div>
          <div class="form-group">
            <label for="id_title_tag">Etiqueta de título</label>
            {{ information_form.title_tag }}
          </div>
          <div class="form-group">
            <label for="id_summary">Resumen</label>
            {{ information_form.summary }}
          </div>
          <div class="form-group">
            <label for="id_category">Categoría</label>
            {{ information_form.category }}
          </div>
          <div class="form-group">
            <label for="id_keywords">Etiquetas</label>
            {{ information_form.keywords }}
          </div>
        </div>
      </div>

      <!-- Cuerpo Tab -->
      <div class="tab-pane fade" id="cuerpo" role="tabpanel" aria-labelledby="cuerpo-tab">
        <div class="py-3">
          <div class="form-group">
            {{ form.media }}
            {{ body_form.body }}
          </div>
        </div>
      </div>

      <!-- Historial de versiones Tab -->
      <div class="tab-pane fade" id="historial" role="tabpanel" aria-labelledby="historial-tab">
        <div class="py-3">
          <h2>Historial de versiones</h2>
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Usuario</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for record in post_history_page %}
              <tr>
                <td>{{ record.history_date|date:"d M Y, H:i" }}</td>
                <td>
                  {% if record.history_type == '+' %}
                  Creado
                  {% elif record.history_type == '~' %}
                  Actualizado
                  {% elif record.history_type == '-' %}
                  Eliminado
                  {% endif %}
                </td>
                <td>{{ record.history_user }}</td>
                <td><a href="{% url 'history' post.pk record.history_id %}">Ver detalles</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Pagination Controls -->
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" data-bs-theme="dark">
              {% if post_history_page.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ post_history_page.previous_page_number }}#historial"
                  aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              {% endif %}
              {% for num in post_history_page.paginator.page_range %}
              <li class="page-item {% if post_history_page.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}#historial">{{ num }}</a>
              </li>
              {% endfor %}
              {% if post_history_page.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ post_history_page.next_page_number }}#historial" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>

      <!-- Observaciones de versiones Tab -->
      <div class="tab-pane fade" id="observaciones" role="tabpanel" aria-labelledby="observaciones-tab">
        <div class="container-fluid">
          <div class="py-3">
            <h2>Observaciones de cambios de estado</h2>
            <table class="table table-dark table-hover">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Usuario</th>
                  <th>Estado Anterior</th>
                  <th>Estado Nuevo</th>
                  <th>Observación</th>
                </tr>
              </thead>
              <tbody>
                {% for record in post_history_page %}
                <tr>
                  <td>{{ record.history_date|date:"d M Y, H:i" }}</td>
                  <td>{{ record.history_user }}</td>
                  <td>
                    {% if record.prev_record %}
                    {{ state_mapping|dict_get:record.prev_record.status }}
                    {% else %}
                    Sin estado anterior
                    {% endif %}
                  </td>
                  <td>
                    {{ state_mapping|dict_get:record.status }}
                  </td>
                  <td>{{ record.change_reason }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <!-- Pagination Controls -->
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center" data-bs-theme="dark">
                {% if post_history_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ post_history_page.previous_page_number }}#observaciones"
                    aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                {% endif %}
                {% for num in post_history_page.paginator.page_range %}
                <li class="page-item {% if post_history_page.number == num %}active{% endif %}">
                  <a class="page-link" href="?page={{ num }}#observaciones">{{ num }}</a>
                </li>
                {% endfor %}
                {% if post_history_page.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ post_history_page.next_page_number }}#observaciones"
                    aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>
      </div>
      {% else %}
      <!-- Si el post no está en estado "draft" -->
      <h1>{{ post.title }}</h1>
      <blockquote class="blockquote">
        <small>{{ post.summary }}</small>
      </blockquote>
      <hr>
      <p>{{ post.body|safe }}</p>
      <small>Autor: {{ post.author.first_name }} {{ post.author.last_name }}</small><br>
      <small>Categoría: {{ post.category }}</small><br>
      <small>Etiquetas: {{ post.keywords }}</small><br>

      {% if post.status == 'to_publish' %}
      <small>Estado: A publicar</small><br>
      {% elif post.status == 'to_edit' %}
      <small>Estado: En edición</small><br>
      {% endif %}
      {% endif %}

      <br>
      <div class="d-flex justify-content-between">
        <a href="{% url 'my-posts' %}" class="btn btn-secondary btn-light">Volver</a>
        <div>
          <button class="btn btn-success my-0" type="submit">Guardar</button>
          <button type="button" class="btn btn-primary my-0" data-bs-toggle="modal"
            data-bs-target="#changeReasonModal">Mandar a edición</button>
          <button type="button" class="btn btn-danger my-0" data-bs-toggle="modal"
            data-bs-target="#deleteModal">Eliminar</button>
        </div>
      </div>
  </form>
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">Confirmar eliminación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-black">
          ¿Estás seguro de que quieres eliminar este artículo?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <form method="post" action="{% url 'delete-my-post' post.pk %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Confirmar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Change Reason -->
  <div class="modal fade" id="changeReasonModal" tabindex="-1" role="dialog" aria-labelledby="changeReasonLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="changeReasonLabel">Observación</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="changeReasonInput">Agrega una observación para el cambio de estado del artículo:</label>
          <input type="text" id="changeReasonInput" class="form-control bg-dark text-white mt-2">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="submit-change-reason">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

</main>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Check if there's a hash in the URL (e.g., #historial)
    var hash = window.location.hash;

    if (hash) {
      // Find the tab with that hash and show it
      var activeTab = document.querySelector('a[href="' + hash + '"]');
      if (activeTab) {
        var tab = new bootstrap.Tab(activeTab);
        tab.show();
      }
    }

    // Add event listeners to save the clicked tab in the URL hash
    var tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
    tabLinks.forEach(function (tabLink) {
      tabLink.addEventListener('click', function (event) {
        // Update the URL hash when a tab is clicked
        window.location.hash = event.target.getAttribute('href');
      });
    });

    // Handle the change reason modal
    document.getElementById('submit-change-reason').addEventListener('click', function () {
      var reason = document.getElementById('changeReasonInput').value;
      if (reason) {
        var changeReasonInput = document.createElement('input');
        changeReasonInput.type = 'hidden';
        changeReasonInput.name = 'change_reason';
        changeReasonInput.value = reason;
        document.getElementById('post-form').appendChild(changeReasonInput);

        var statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = 'to_edit';
        document.getElementById('post-form').appendChild(statusInput);

        document.getElementById('post-form').submit(); // Submit the form after reason is filled
      } else {
        alert('Please provide a reason for changing the status.');
      }
    });
  });
</script>
<!-- Incluir JavaScript de Bootstrap solo si es "draft" -->
{% if post.status == 'draft' %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var triggerTabList = [].slice.call(document.querySelectorAll('#myTab a'))
    triggerTabList.forEach(function (triggerEl) {
      var tabTrigger = new bootstrap.Tab(triggerEl)

      triggerEl.addEventListener('click', function (event) {
        event.preventDefault()
        tabTrigger.show()
      })
    })
  });
</script>
{% endif %}
{% endblock %}